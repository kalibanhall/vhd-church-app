<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Pastor Availability</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; }
        input, select, button { padding: 8px; margin: 2px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        .result { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test API Pastor Availability</h1>
        
        <div class="form-group">
            <h3>1. Connexion Pasteur</h3>
            <label>Email:</label>
            <input type="email" id="email" value="pasteur.martin@mychurchapp.com">
            <label>Mot de passe:</label>
            <input type="password" id="password" value="pasteur123">
            <button onclick="login()">Se connecter</button>
        </div>

        <div class="form-group">
            <h3>2. Ajouter Disponibilité</h3>
            <label>Jour de la semaine (0=Dimanche, 1=Lundi, etc.):</label>
            <select id="dayOfWeek">
                <option value="1">Lundi</option>
                <option value="2">Mardi</option>
                <option value="3">Mercredi</option>
                <option value="4">Jeudi</option>
                <option value="5">Vendredi</option>
                <option value="6">Samedi</option>
                <option value="0">Dimanche</option>
            </select>
            <label>Heure de début:</label>
            <input type="time" id="startTime" value="09:00">
            <label>Heure de fin:</label>
            <input type="time" id="endTime" value="12:00">
            <button onclick="addAvailability()">Ajouter Créneau</button>
        </div>

        <div class="form-group">
            <h3>3. Lister Disponibilités</h3>
            <button onclick="getAvailability()">Récupérer les Créneaux</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let authToken = '';

        function showResult(message, isError = false) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'result ' + (isError ? 'error' : 'success');
            div.innerHTML = message;
            results.appendChild(div);
        }

        async function login() {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: document.getElementById('email').value,
                        password: document.getElementById('password').value
                    }),
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    showResult('✅ Connexion réussie: ' + data.user.firstName + ' ' + data.user.lastName + ' (' + data.user.role + ')');
                } else {
                    showResult('❌ Erreur de connexion: ' + data.error, true);
                }
            } catch (error) {
                showResult('❌ Erreur réseau: ' + error.message, true);
            }
        }

        async function addAvailability() {
            if (!authToken) {
                showResult('❌ Veuillez vous connecter d\'abord', true);
                return;
            }

            try {
                const availabilityData = {
                    dayOfWeek: parseInt(document.getElementById('dayOfWeek').value),
                    startTime: document.getElementById('startTime').value,
                    endTime: document.getElementById('endTime').value,
                    isAvailable: true
                };

                console.log('Envoi des données:', availabilityData);

                const response = await fetch('/api/pastor/availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(availabilityData),
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult('✅ Créneau ajouté avec succès!');
                } else {
                    showResult('❌ Erreur ' + response.status + ': ' + (data.error || 'Erreur inconnue'), true);
                }
            } catch (error) {
                showResult('❌ Erreur réseau: ' + error.message, true);
            }
        }

        async function getAvailability() {
            if (!authToken) {
                showResult('❌ Veuillez vous connecter d\'abord', true);
                return;
            }

            try {
                const response = await fetch('/api/pastor/availability', {
                    method: 'GET',
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (response.ok) {
                    if (data.availability && data.availability.length > 0) {
                        const daysOfWeek = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                        let result = '✅ Créneaux de disponibilité:<br>';
                        data.availability.forEach(slot => {
                            result += `• ${daysOfWeek[slot.dayOfWeek]}: ${slot.startTime} - ${slot.endTime}<br>`;
                        });
                        showResult(result);
                    } else {
                        showResult('ℹ️ Aucun créneau de disponibilité trouvé');
                    }
                } else {
                    showResult('❌ Erreur ' + response.status + ': ' + (data.error || 'Erreur inconnue'), true);
                }
            } catch (error) {
                showResult('❌ Erreur réseau: ' + error.message, true);
            }
        }
    </script>
</body>
</html>